---
title: Gestionar secretos
description: Rotar secretos de consumidor y validar cada entrega de Chainhooks
---
## Lo que aprenderás

:::objectives
* Crear/rotar un secreto de consumidor de Chainhooks.
* Valida las solicitudes de webhook verificando el `Authorization` cabecera.
:::

## Prerrequisitos

:::prerequisites
* Clave API de Hiro
* Node.js (el ejemplo del servidor utiliza Fastify).
:::

## Validando solicitudes de webhook con un secreto de consumidor

Cuando creas un secreto, nuestro servicio Chainhooks adjunta un `Authorization: Bearer <secret>` encabezado a cada intento de webhook, dándote un simple intercambio de secreto compartido. Aquí te explicamos cómo empezar:

1. Rotar el secreto con `rotateConsumerSecret` (o el `/chainhooks/{uuid}/secret` API) cada vez que necesites inicializar o crear un nuevo token.
2. Rechazar las entregas de webhook cuyas `Authorization` el encabezado no es igual a `Bearer <current-secret>`.

### Crear/rotar secreto de consumidor

```ts -nc server.ts
import { ChainhooksClient, CHAINHOOKS_BASE_URL } from '@hirosystems/chainhooks-client';

const client = new ChainhooksClient({
  baseUrl: CHAINHOOKS_BASE_URL.mainnet, // or .testnet / custom URL
  apiKey: process.env.HIRO_API_KEY!,
});

// Store this value securely and use it to validate webhook requests
const secret = await client.rotateConsumerSecret(chainhookUuid).secret;
```

### Ejemplo de servidor Fastify

```ts -nc -n
import Fastify from 'fastify';

const server = Fastify();

server.post('/webhook', async (request, reply) => {
  if (!secret) {
    reply.code(503).send({ error: 'consumer secret unavailable' });
    return;
  }

  const authHeader = request.headers.authorization;
  if (authHeader !== `Bearer ${secret}`) {
    reply.code(401).send({ error: 'invalid consumer secret' });
    return;
  }

  const event = request.body;
  console.log(`received chainhook ${event.chainhook.uuid}`);
  reply.code(204).send();
});

await server.listen({ port: Number(process.env.PORT) || 3000 });
```
